<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Behavior Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .dark ::-webkit-scrollbar-track {
        background: #2d3748;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #4a5568;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .status-select,
      .form-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 0.7rem center;
        background-size: 0.65rem auto;
        padding-right: 2rem;
      }
      /* Style for selected study case card */
      .case-card.selected {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
      .case-card {
        position: relative;
        display: flex;
        flex-direction: column;
      }
      #notification {
        transition: transform 0.5s ease-in-out;
      }
      .case-description {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 60px; /* Approx 3 lines of text */
      }
    </style>
    <script>
      // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
      if (
        localStorage.getItem("theme") === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <header class="text-center mb-8 relative">
        <h1
          class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">
          Student Behavior Tracker
        </h1>
        <p class="text-md text-gray-600 dark:text-gray-400 mt-2">
          Collaborate on study cases and track solutions.
        </p>
        <button
          id="theme-toggle"
          class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
          <svg
            id="theme-icon-light"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <svg
            id="theme-icon-dark"
            class="w-6 h-6 hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>
      </header>

      <!-- Notification Area -->
      <div
        id="notification"
        class="hidden fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full z-50">
        <p id="notification-message"></p>
      </div>

      <!-- Study Cases Section -->
      <div class="mb-12">
        <div
          class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
          <div class="flex items-center gap-4">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
              Study Cases
            </h2>
            <button
              id="clear-selection-btn"
              class="hidden bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold px-3 py-1 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-sm transition">
              &larr; Back to Student Log
            </button>
          </div>
          <button
            id="add-case-btn"
            class="w-full sm:w-auto bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
            Add New Case
          </button>
        </div>
        <div id="study-cases-grid" class="flex flex-wrap justify-center gap-6">
          <!-- Study case cards will be injected here -->
          <p
            id="cases-loading-state"
            class="text-gray-500 dark:text-gray-400 text-center">
            Loading study cases...
          </p>
        </div>
        <div class="text-center mt-4">
          <button
            id="view-all-cases-btn"
            class="hidden bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            View All Cases
          </button>
        </div>
      </div>

      <!-- Student Log Form Section -->
      <div
        id="student-log-section"
        class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Student Log
        </h2>
        <form id="student-log-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label
                for="log-instructor-name"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Instructor Name</label
              >
              <input
                type="text"
                id="log-instructor-name"
                name="instructor-name"
                required
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
                placeholder="e.g., Mr. Smith" />
            </div>
            <div>
              <label
                for="log-student-name"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Student's Name</label
              >
              <input
                type="text"
                id="log-student-name"
                name="student-name"
                required
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
                placeholder="e.g., John Doe" />
            </div>
            <div>
              <label
                for="log-location"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Location</label
              >
              <select
                id="log-location"
                name="location"
                required
                class="form-select w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"></select>
            </div>
            <div>
              <label
                for="log-student-level"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Student Level</label
              >
              <select
                id="log-student-level"
                name="student-level"
                required
                class="form-select w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"></select>
            </div>
          </div>
          <div>
            <label
              for="log-behavior"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >Behavior</label
            >
            <textarea
              id="log-behavior"
              name="behavior"
              rows="3"
              required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
              placeholder="Describe the specific behavior observed..."></textarea>
          </div>
          <div>
            <label
              for="log-comment"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >Comment</label
            >
            <textarea
              id="log-comment"
              name="comment"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
              placeholder="Add any additional comments or context..."></textarea>
          </div>
          <div class="text-right">
            <button
              type="submit"
              class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700">
              Add Log Entry
            </button>
          </div>
        </form>
      </div>

      <!-- Case Solution Form Section (Initially Hidden) -->
      <div
        id="case-solution-section"
        class="hidden max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h2
          id="solution-form-title"
          class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Add Solution
        </h2>
        <form id="case-solution-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label
                for="solution-instructor-name"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Instructor Name</label
              >
              <input
                type="text"
                id="solution-instructor-name"
                required
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
                placeholder="e.g., Ms. Jones" />
            </div>
            <div>
              <label
                for="solution-location"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >Location</label
              >
              <select
                id="solution-location"
                required
                class="form-select w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"></select>
            </div>
          </div>
          <div>
            <label
              for="solution-text"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >Solution / Comment</label
            >
            <textarea
              id="solution-text"
              rows="4"
              required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"
              placeholder="Propose a solution or add a comment..."></textarea>
          </div>
          <div class="text-right">
            <button
              type="submit"
              class="bg-green-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-700">
              Add Solution
            </button>
          </div>
        </form>
      </div>

      <div class="mt-12">
        <div
          class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
          <h2
            id="tracker-title"
            class="text-2xl font-bold text-gray-900 dark:text-white">
            Student Log Tracker
          </h2>
          <div class="flex items-center space-x-2">
            <label
              for="location-filter"
              class="text-sm font-medium text-gray-700 dark:text-gray-300"
              >Filter by Location:</label
            >
            <select
              id="location-filter"
              name="location-filter"
              class="form-select w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"></select>
          </div>
        </div>
        <div
          class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table
              class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead
                id="tracker-table-head"
                class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-100 dark:bg-gray-700">
                <!-- Header will be dynamically set -->
              </thead>
              <tbody id="progress-table-body">
                <!-- Rows will be injected by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div
      id="add-case-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white dark:bg-gray-900">
        <h3
          class="text-xl leading-6 font-medium text-gray-900 dark:text-white mb-4">
          Add New Study Case
        </h3>
        <form id="add-case-form" class="space-y-4">
          <div>
            <label
              for="case-title"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Title</label
            >
            <input
              type="text"
              id="case-title"
              required
              class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md"
              placeholder="A brief, descriptive title" />
          </div>
          <div>
            <label
              for="case-group"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Group</label
            >
            <select
              id="case-group"
              required
              class="form-select w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md"></select>
          </div>
          <div>
            <label
              for="case-description"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Description</label
            >
            <textarea
              id="case-description"
              rows="4"
              required
              class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md"
              placeholder="Describe the case in detail..."></textarea>
          </div>
          <div class="flex justify-end gap-4 pt-4">
            <button
              type="button"
              id="modal-case-cancel"
              class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
              Create Case
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="view-all-cases-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div
        class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white dark:bg-gray-900">
        <div
          class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
          <h3
            class="text-xl leading-6 font-medium text-gray-900 dark:text-white">
            All Study Cases
          </h3>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <label
                for="case-group-filter"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                >Group:</label
              >
              <select
                id="case-group-filter"
                class="form-select w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg"></select>
            </div>
            <div class="flex items-center space-x-2">
              <label
                for="case-sort-filter"
                class="text-sm font-medium text-gray-700 dark:text-gray-300"
                >Sort by:</label
              >
              <select
                id="case-sort-filter"
                class="form-select w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg">
                <option value="latest">Latest</option>
                <option value="most-agreed">Most Agreed</option>
              </select>
            </div>
          </div>
          <button
            id="modal-view-all-close"
            class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 sm:relative sm:top-auto sm:right-auto">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div
          id="all-cases-container"
          class="max-h-96 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 p-1">
          <!-- All case cards will be injected here -->
        </div>
      </div>
    </div>

    <div
      id="view-details-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div
        class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-gray-900">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="details-modal-title"
            class="text-xl leading-6 font-medium text-gray-900 dark:text-white">
            Case Details
          </h3>
          <button
            id="modal-details-close"
            class="text-gray-400 hover:text-gray-600">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="max-h-[70vh] grid grid-cols-1 md:grid-cols-2 gap-x-6">
          <!-- Left Column: Case Details -->
          <div class="overflow-y-auto pr-4">
            <div id="details-modal-group" class="mb-2"></div>
            <p
              id="details-modal-description"
              class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></p>
          </div>
          <!-- Right Column: Solutions -->
          <div
            class="overflow-y-auto md:border-l border-gray-200 dark:border-gray-700 md:pl-6 mt-6 md:mt-0 pt-6 md:pt-0 border-t md:border-t-0">
            <h4
              class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
              Solutions from Instructors
            </h4>
            <div
              id="details-modal-solutions-container"
              class="space-y-4 max-h-96 overflow-y-auto pr-2">
              <!-- Solutions will be injected here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="log-details-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div
        class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-gray-900">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="log-details-modal-title"
            class="text-xl leading-6 font-medium text-gray-900 dark:text-white">
            Log Details
          </h3>
          <button
            id="modal-log-details-close"
            class="text-gray-400 hover:text-gray-600">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="max-h-[70vh] grid grid-cols-1 md:grid-cols-2 gap-x-6">
          <!-- Left Column: Log Details -->
          <div class="overflow-y-auto pr-4 space-y-4">
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-white">
                Student
              </h4>
              <p
                id="log-details-student"
                class="text-gray-600 dark:text-gray-400"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-white">Level</h4>
              <p
                id="log-details-level"
                class="text-gray-600 dark:text-gray-400"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-white">
                Behavior
              </h4>
              <p
                id="log-details-behavior"
                class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap"></p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800 dark:text-white">
                Comment
              </h4>
              <p
                id="log-details-comment"
                class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap"></p>
            </div>
          </div>
          <!-- Right Column: Solutions -->
          <div
            class="overflow-y-auto md:border-l border-gray-200 dark:border-gray-700 md:pl-6 mt-6 md:mt-0 pt-6 md:pt-0 border-t md:border-t-0">
            <h4
              class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
              Solutions
            </h4>
            <div
              id="log-details-solutions-container"
              class="space-y-4 max-h-56 overflow-y-auto pr-2 mb-6">
              <!-- Log Solutions will be injected here -->
            </div>
            <form
              id="log-solution-form"
              class="space-y-4 border-t dark:border-gray-700 pt-4">
              <div>
                <label
                  for="log-solution-instructor"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                  >Your Name</label
                >
                <input
                  type="text"
                  id="log-solution-instructor"
                  required
                  class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md" />
              </div>
              <div>
                <label
                  for="log-solution-location"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                  >Your Location</label
                >
                <select
                  id="log-solution-location"
                  required
                  class="form-select w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md"></select>
              </div>
              <div>
                <label
                  for="log-solution-text"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                  >Proposed Solution</label
                >
                <textarea
                  id="log-solution-text"
                  rows="3"
                  required
                  class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md"></textarea>
              </div>
              <div class="text-right">
                <button
                  type="submit"
                  class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700">
                  Submit Solution
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div
      id="delete-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-900">
        <div class="mt-3 text-center">
          <div
            class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <svg
              class="h-6 w-6 text-red-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h3
            id="delete-modal-title"
            class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            Delete Item
          </h3>
          <div class="mt-2 px-7 py-3">
            <p
              id="delete-modal-text"
              class="text-sm text-gray-500 dark:text-gray-400">
              Are you sure you want to delete this? This action cannot be
              undone.
            </p>
          </div>
          <div class="items-center px-4 py-3">
            <button
              id="modal-delete-confirm"
              class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              Delete</button
            ><button
              id="modal-delete-cancel"
              class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Firebase Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        serverTimestamp,
        increment,
        query,
        where,
        getDocs,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- IMPORTANT: Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyA-RzTiyUcK6d61S_pbMSHeCdbXdNIhsq0",
        authDomain: "students-tracker-3847c.firebaseapp.com",
        projectId: "students-tracker-3847c",
        storageBucket: "students-tracker-3847c.appspot.com",
        messagingSenderId: "712494461896",
        appId: "1:712494461896:web:cd4cb7b4de0b16e0bbc6fd",
        measurementId: "G-4PXNM15WB8",
      };

      // --- Initialize Firebase ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const studentLogSection = document.getElementById("student-log-section");
      const studentLogForm = document.getElementById("student-log-form");
      const caseSolutionSection = document.getElementById(
        "case-solution-section"
      );
      const caseSolutionForm = document.getElementById("case-solution-form");
      const solutionFormTitle = document.getElementById("solution-form-title");
      const tableBody = document.getElementById("progress-table-body");
      const tableHead = document.getElementById("tracker-table-head");
      const trackerTitle = document.getElementById("tracker-title");
      const notification = document.getElementById("notification");
      const notificationMessage = document.getElementById(
        "notification-message"
      );
      const locationFilter = document.getElementById("location-filter");
      const studyCasesGrid = document.getElementById("study-cases-grid");
      const casesLoadingState = document.getElementById("cases-loading-state");
      const viewAllCasesBtn = document.getElementById("view-all-cases-btn");
      const clearSelectionBtn = document.getElementById("clear-selection-btn");

      // Modals
      const deleteModal = document.getElementById("delete-modal");
      const deleteModalTitle = document.getElementById("delete-modal-title");
      const deleteModalText = document.getElementById("delete-modal-text");
      const modalDeleteConfirm = document.getElementById(
        "modal-delete-confirm"
      );
      const modalDeleteCancel = document.getElementById("modal-delete-cancel");
      const addCaseModal = document.getElementById("add-case-modal");
      const addCaseForm = document.getElementById("add-case-form");
      const addCaseBtn = document.getElementById("add-case-btn");
      const modalCaseCancel = document.getElementById("modal-case-cancel");
      const viewAllCasesModal = document.getElementById("view-all-cases-modal");
      const allCasesContainer = document.getElementById("all-cases-container");
      const modalViewAllClose = document.getElementById("modal-view-all-close");
      const caseSortFilter = document.getElementById("case-sort-filter");
      const caseGroupFilter = document.getElementById("case-group-filter");
      const viewDetailsModal = document.getElementById("view-details-modal");
      const modalDetailsClose = document.getElementById("modal-details-close");
      const logDetailsModal = document.getElementById("log-details-modal");
      const modalLogDetailsClose = document.getElementById(
        "modal-log-details-close"
      );
      const logSolutionForm = document.getElementById("log-solution-form");

      // --- App State ---
      let currentUserId = null;
      let itemToDelete = { id: null, type: null };
      let allStudentLogs = [];
      let allCaseSolutions = [];
      let allLogSolutions = [];
      let allCases = [];
      let selectedCaseId = null;
      let selectedLogId = null;

      const locationOptions = [
        "The Lab Puri Indah",
        "The Lab Gading Serpong",
        "The Lab Pluit Village",
        "The Lab Kelapa Gading",
        "The Lab Pondok Indah",
      ];
      const levelOptions = [
        "Kinder Foundation",
        "Kinder Term 1",
        "Kinder Term 2",
        "Kinder Term 3",
        "Kinder Term 4",
        "Junior Foundation 1",
        "Junior Foundation 2",
        "Junior Term 1",
        "Junior Term 2",
        "Junior Term 3",
        "Junior Term 4",
        "Basic 1",
        "Basic 2",
        "Intermediate 1",
        "Intermediate 2",
        "Advance 1",
        "Advance 2",
        "Advance 3",
      ];
      const groupOptions = [
        "General",
        "Kinder Foundation",
        "Kinder",
        "Junior Foundation",
        "Junior",
        "Coder Low Level",
        "Coder High Level",
      ];
      const solutionStatusOptions = ["Pending", "Effective", "Ineffective"];

      // --- Authentication ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid;
          initializeListeners();
          populateSelects();
          renderStudentLogTable(); // Initial view
        } else {
          signInAnonymously(auth).catch((error) =>
            console.error("Anonymous sign-in failed:", error)
          );
        }
      });

      // --- Firestore Collection References ---
      const studyCasesCollectionRef = collection(db, "studyCases");
      const studentLogsCollectionRef = collection(db, "studentLogs");
      const caseSolutionsCollectionRef = collection(db, "caseSolutions");
      const logSolutionsCollectionRef = collection(db, "logSolutions");

      // --- Functions ---
      function populateSelects() {
        const locationHTML = locationOptions
          .map((opt) => `<option value="${opt}">${opt}</option>`)
          .join("");
        const levelHTML = levelOptions
          .map((opt) => `<option value="${opt}">${opt}</option>`)
          .join("");
        const groupHTML = groupOptions
          .map((opt) => `<option value="${opt}">${opt}</option>`)
          .join("");

        document.getElementById("log-location").innerHTML = locationHTML;
        document.getElementById("solution-location").innerHTML = locationHTML;
        document.getElementById("log-student-level").innerHTML = levelHTML;
        document.getElementById("case-group").innerHTML = groupHTML;
        document.getElementById("log-solution-location").innerHTML =
          locationHTML;
        locationFilter.innerHTML =
          '<option value="all">All Locations</option>' + locationHTML;
        caseGroupFilter.innerHTML =
          '<option value="all">All Groups</option>' + groupHTML;
      }

      function showNotification(message, type = "success") {
        notificationMessage.textContent = message;
        notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-transform transform ${
          type === "success" ? "bg-blue-500" : "bg-red-500"
        } z-50`;
        notification.classList.remove("translate-x-full", "hidden");
        setTimeout(() => notification.classList.add("translate-x-full"), 3000);
        setTimeout(() => notification.classList.add("hidden"), 3500);
      }

      function createCaseCard(caseData) {
        const card = document.createElement("div");
        card.className =
          "case-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border dark:border-gray-700 w-full max-w-sm flex flex-col";
        card.dataset.id = caseData.id;

        const groupColors = {
          General: "bg-green-500",
          "Kinder Foundation": "bg-pink-500",
          Kinder: "bg-pink-500",
          "Junior Foundation": "bg-blue-500",
          Junior: "bg-blue-500",
          "Coder Low Level": "bg-gray-800",
          "Coder High Level": "bg-gray-800",
        };
        const groupColor = groupColors[caseData.group] || "bg-gray-500";

        card.innerHTML = `
                <button class="delete-case-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition z-10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
                <div class="case-content-wrapper cursor-pointer flex-grow pr-8">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg text-gray-800 dark:text-white pointer-events-none">${
                          caseData.title
                        }</h3>
                        <span class="text-xs font-semibold text-white ${groupColor} px-2 py-1 rounded-full pointer-events-none ml-2 flex-shrink-0">${
          caseData.group
        }</span>
                    </div>
                    <p class="case-description text-gray-600 dark:text-gray-400 text-sm mt-2 pointer-events-none">${
                      caseData.description
                    }</p>
                </div>
                <div class="flex items-center justify-between mt-3 text-sm pt-2 border-t border-gray-200 dark:border-gray-700">
                    <button class="view-details-btn text-blue-600 dark:text-blue-400 hover:underline font-semibold">View Details</button>
                    <div class="flex items-center">
                        <button class="agree-btn flex items-center text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 font-semibold transition">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 18.734V11a2 2 0 012-2h2M7 11V7a2 2 0 012-2h2"></path></svg>
                            Agree
                        </button>
                        <span class="ml-2 text-green-600 dark:text-green-400 font-bold">${
                          caseData.agreements || 0
                        }</span>
                    </div>
                </div>
            `;
        if (caseData.id === selectedCaseId) card.classList.add("selected");
        return card;
      }

      function renderStudyCases() {
        studyCasesGrid.innerHTML = "";
        allCases.sort(
          (a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)
        );

        if (allCases.length === 0) {
          casesLoadingState.textContent =
            "No study cases found. Add one to get started!";
          studyCasesGrid.appendChild(casesLoadingState);
          viewAllCasesBtn.classList.add("hidden");
          return;
        }
        casesLoadingState.style.display = "none";

        const casesToDisplay = allCases.slice(0, 2);
        casesToDisplay.forEach((caseData) => {
          const card = createCaseCard(caseData);
          studyCasesGrid.appendChild(card);
        });
        viewAllCasesBtn.classList.toggle("hidden", allCases.length <= 2);
      }

      function populateViewAllModal() {
        allCasesContainer.innerHTML = "";
        const sortBy = caseSortFilter.value;
        const selectedGroup = caseGroupFilter.value;

        let filteredCases =
          selectedGroup === "all"
            ? [...allCases]
            : allCases.filter((c) => c.group === selectedGroup);

        const sortedCases = filteredCases.sort((a, b) => {
          if (sortBy === "most-agreed")
            return (b.agreements || 0) - (a.agreements || 0);
          return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
        });
        sortedCases.forEach((caseData) => {
          const card = createCaseCard(caseData);
          allCasesContainer.appendChild(card);
        });
      }

      function showCaseDetailsModal(caseId) {
        const caseData = allCases.find((c) => c.id === caseId);
        const solutions = allCaseSolutions
          .filter((s) => s.caseId === caseId)
          .sort(
            (a, b) =>
              (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)
          );

        const groupColors = {
          General: "bg-green-500",
          "Kinder Foundation": "bg-pink-500",
          Kinder: "bg-pink-500",
          "Junior Foundation": "bg-blue-500",
          Junior: "bg-blue-500",
          "Coder Low Level": "bg-gray-800",
          "Coder High Level": "bg-gray-800",
        };
        const groupColor = groupColors[caseData.group] || "bg-gray-500";

        document.getElementById("details-modal-title").textContent =
          caseData.title;
        document.getElementById(
          "details-modal-group"
        ).innerHTML = `<span class="text-xs font-semibold text-white ${groupColor} px-2 py-1 rounded-full">${caseData.group}</span>`;
        document.getElementById("details-modal-description").textContent =
          caseData.description;

        const solutionsContainer = document.getElementById(
          "details-modal-solutions-container"
        );
        solutionsContainer.innerHTML = "";

        if (solutions.length > 0) {
          solutions.forEach((sol) => {
            const solEl = document.createElement("div");
            solEl.className =
              "p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600";
            solEl.innerHTML = `
                        <p class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${
                          sol.solution
                        }</p>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t dark:border-gray-600">
                            <p class="text-xs text-gray-500 dark:text-gray-400">- ${
                              sol.instructorName
                            } (${sol.location})</p>
                            <div class="flex items-center">
                                <button data-solution-id="${
                                  sol.id
                                }" class="solution-agree-btn flex items-center text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 font-semibold transition">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 18.734V11a2 2 0 012-2h2M7 11V7a2 2 0 012-2h2"></path></svg>
                                    Agree
                                </button>
                                <span class="ml-2 text-green-600 dark:text-green-400 font-bold">${
                                  sol.agreements || 0
                                }</span>
                            </div>
                        </div>
                    `;
            solutionsContainer.appendChild(solEl);
          });
        } else {
          solutionsContainer.innerHTML =
            '<p class="text-gray-500 dark:text-gray-400">No solutions have been submitted for this case yet.</p>';
        }
        viewDetailsModal.classList.remove("hidden");
      }

      function showLogDetailsModal(logId) {
        selectedLogId = logId;
        const logData = allStudentLogs.find((l) => l.id === logId);
        const solutions = allLogSolutions
          .filter((s) => s.logId === logId)
          .sort(
            (a, b) =>
              (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)
          );

        document.getElementById(
          "log-details-modal-title"
        ).textContent = `Details for ${logData.studentName}`;
        document.getElementById(
          "log-details-student"
        ).textContent = `${logData.studentName} (${logData.location})`;
        document.getElementById("log-details-level").textContent =
          logData.studentLevel;
        document.getElementById("log-details-behavior").textContent =
          logData.behavior;
        document.getElementById("log-details-comment").textContent =
          logData.comment || "N/A";

        const solutionsContainer = document.getElementById(
          "log-details-solutions-container"
        );
        solutionsContainer.innerHTML = "";

        if (solutions.length > 0) {
          solutions.forEach((sol) => {
            const solEl = document.createElement("div");
            solEl.className =
              "p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600";
            const statusColors = {
              Pending: "bg-yellow-100 text-yellow-800",
              Effective: "bg-green-100 text-green-800",
              Ineffective: "bg-red-100 text-red-800",
            };
            const selectHTML = `<select data-solution-id="${
              sol.id
            }" class="log-solution-status-select text-xs font-semibold p-2 rounded-md border-0 focus:ring-2 focus:ring-blue-400 ${
              statusColors[sol.status] || "bg-gray-100"
            }">${solutionStatusOptions
              .map(
                (opt) =>
                  `<option value="${opt}" ${
                    sol.status === opt ? "selected" : ""
                  }>${opt}</option>`
              )
              .join("")}</select>`;
            solEl.innerHTML = `
                        <p class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${sol.solution}</p>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t dark:border-gray-600">
                            <p class="text-xs text-gray-500 dark:text-gray-400">- ${sol.instructorName} (${sol.location})</p>
                            ${selectHTML}
                        </div>
                    `;
            solutionsContainer.appendChild(solEl);
          });
        } else {
          solutionsContainer.innerHTML =
            '<p class="text-gray-500 dark:text-gray-400">No solutions have been submitted for this log yet.</p>';
        }

        logDetailsModal.classList.remove("hidden");
      }

      function handleCaseClick(caseId, caseTitle) {
        selectedCaseId = caseId;
        studentLogSection.classList.add("hidden");
        caseSolutionSection.classList.remove("hidden");
        solutionFormTitle.textContent = `Add Solution for: ${caseTitle}`;
        clearSelectionBtn.classList.remove("hidden");
        document
          .querySelectorAll(".case-card")
          .forEach((c) => c.classList.remove("selected"));
        document
          .querySelectorAll(`.case-card[data-id="${caseId}"]`)
          .forEach((c) => c.classList.add("selected"));
        renderCaseSolutionsTable();
      }

      function handleClearSelection() {
        selectedCaseId = null;
        studentLogSection.classList.remove("hidden");
        caseSolutionSection.classList.add("hidden");
        clearSelectionBtn.classList.add("hidden");
        document
          .querySelectorAll(".case-card")
          .forEach((c) => c.classList.remove("selected"));
        renderStudentLogTable();
      }

      function renderStudentLogTable() {
        trackerTitle.textContent = "Student Log Tracker";
        tableHead.innerHTML = `
                <tr>
                    <th scope="col" class="px-6 py-3">Instructor</th><th scope="col" class="px-6 py-3">Student</th>
                    <th scope="col" class="px-6 py-3">Level</th><th scope="col" class="px-6 py-3">Location</th>
                    <th scope="col" class="px-6 py-3">Behavior</th>
                    <th scope="col" class="px-6 py-3 text-center">Actions</th>
                </tr>`;

        const selectedLocation = locationFilter.value;
        let logsToRender =
          selectedLocation === "all"
            ? allStudentLogs
            : allStudentLogs.filter((log) => log.location === selectedLocation);
        logsToRender.sort(
          (a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)
        );

        tableBody.innerHTML = "";
        if (logsToRender.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="6" class="text-center p-8 text-gray-500 dark:text-gray-400">No student logs found.</td></tr>';
          return;
        }
        logsToRender.forEach((log) => {
          const tr = document.createElement("tr");
          tr.className =
            "bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";
          tr.dataset.id = log.id;
          tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">${log.instructorName}</td>
                    <td class="px-6 py-4">${log.studentName}</td>
                    <td class="px-6 py-4">${log.studentLevel}</td><td class="px-6 py-4">${log.location}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${log.behavior}">${log.behavior}</td>
                    <td class="px-6 py-4 text-center">
                        <button class="view-log-details-btn text-blue-600 dark:text-blue-400 hover:underline font-semibold mr-4">View Details</button>
                        <button class="delete-log-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    </td>`;
          tableBody.appendChild(tr);
        });
      }

      function renderCaseSolutionsTable() {
        trackerTitle.textContent = "Case Solutions Tracker";
        tableHead.innerHTML = `
                <tr>
                    <th scope="col" class="px-6 py-3">Instructor</th><th scope="col" class="px-6 py-3">Location</th>
                    <th scope="col" class="px-6 py-3">Solution / Comment</th>
                    <th scope="col" class="px-6 py-3 text-center">Actions</th>
                </tr>`;

        const selectedLocation = locationFilter.value;
        let solutionsToRender = allCaseSolutions.filter(
          (s) => s.caseId === selectedCaseId
        );
        if (selectedLocation !== "all") {
          solutionsToRender = solutionsToRender.filter(
            (s) => s.location === selectedLocation
          );
        }
        solutionsToRender.sort(
          (a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)
        );

        tableBody.innerHTML = "";
        if (solutionsToRender.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="4" class="text-center p-8 text-gray-500 dark:text-gray-400">No solutions for this case yet.</td></tr>';
          return;
        }
        solutionsToRender.forEach((sol) => {
          const tr = document.createElement("tr");
          tr.className =
            "bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";
          tr.dataset.id = sol.id;
          tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">${sol.instructorName}</td>
                    <td class="px-6 py-4">${sol.location}</td>
                    <td class="px-6 py-4 whitespace-pre-wrap">${sol.solution}</td>
                    <td class="px-6 py-4 text-center"><button class="delete-solution-btn text-red-500 hover:text-red-700 font-semibold">Delete</button></td>`;
          tableBody.appendChild(tr);
        });
      }

      async function deleteCaseAndSolutions(caseId) {
        const batch = writeBatch(db);
        const solutionsQuery = query(
          caseSolutionsCollectionRef,
          where("caseId", "==", caseId)
        );
        const solutionsSnapshot = await getDocs(solutionsQuery);
        solutionsSnapshot.forEach((doc) => batch.delete(doc.ref));
        batch.delete(doc(db, "studyCases", caseId));
        await batch.commit();
        if (selectedCaseId === caseId) handleClearSelection();
      }

      async function deleteLogAndSolutions(logId) {
        const batch = writeBatch(db);
        const solutionsQuery = query(
          logSolutionsCollectionRef,
          where("logId", "==", logId)
        );
        const solutionsSnapshot = await getDocs(solutionsQuery);
        solutionsSnapshot.forEach((doc) => batch.delete(doc.ref));
        batch.delete(doc(db, "studentLogs", logId));
        await batch.commit();
      }

      // --- Theme Toggling ---
      function applyTheme(theme) {
        const lightIcon = document.getElementById("theme-icon-light");
        const darkIcon = document.getElementById("theme-icon-dark");
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          document.documentElement.classList.remove("dark");
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }

      // --- Listeners ---
      function initializeListeners() {
        onSnapshot(
          studyCasesCollectionRef,
          (snapshot) => {
            allCases = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderStudyCases();
            populateViewAllModal();
          },
          (error) => {
            console.error("Firestore error (studyCases): ", error);
            casesLoadingState.textContent =
              "Error loading cases. Check permissions and connection.";
          }
        );
        onSnapshot(
          studentLogsCollectionRef,
          (snapshot) => {
            allStudentLogs = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            if (!selectedCaseId) renderStudentLogTable();
          },
          (error) => {
            console.error("Firestore error (studentLogs): ", error);
            if (!selectedCaseId)
              tableBody.innerHTML =
                '<tr><td colspan="7" class="text-center p-8 text-red-500">Error loading student logs.</td></tr>';
          }
        );
        onSnapshot(
          caseSolutionsCollectionRef,
          (snapshot) => {
            allCaseSolutions = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            if (selectedCaseId) renderCaseSolutionsTable();
          },
          (error) => {
            console.error("Firestore error (caseSolutions): ", error);
            if (selectedCaseId)
              tableBody.innerHTML =
                '<tr><td colspan="4" class="text-center p-8 text-red-500">Error loading solutions.</td></tr>';
          }
        );
        onSnapshot(
          logSolutionsCollectionRef,
          (snapshot) => {
            allLogSolutions = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            if (selectedLogId) showLogDetailsModal(selectedLogId); // Refresh modal if open
          },
          (error) => {
            console.error("Firestore error (logSolutions): ", error);
          }
        );
      }

      studentLogForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        await addDoc(studentLogsCollectionRef, {
          instructorName: document.getElementById("log-instructor-name").value,
          studentName: document.getElementById("log-student-name").value,
          location: document.getElementById("log-location").value,
          studentLevel: document.getElementById("log-student-level").value,
          behavior: document.getElementById("log-behavior").value,
          comment: document.getElementById("log-comment").value,
          createdAt: serverTimestamp(),
          authorId: currentUserId,
        });
        studentLogForm.reset();
        showNotification("Student log entry added!", "success");
      });

      caseSolutionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        await addDoc(caseSolutionsCollectionRef, {
          caseId: selectedCaseId,
          instructorName: document.getElementById("solution-instructor-name")
            .value,
          location: document.getElementById("solution-location").value,
          solution: document.getElementById("solution-text").value,
          agreements: 0,
          createdAt: serverTimestamp(),
          authorId: currentUserId,
        });
        caseSolutionForm.reset();
        showNotification("Solution added successfully!", "success");
      });

      logSolutionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        await addDoc(logSolutionsCollectionRef, {
          logId: selectedLogId,
          instructorName: document.getElementById("log-solution-instructor")
            .value,
          location: document.getElementById("log-solution-location").value,
          solution: document.getElementById("log-solution-text").value,
          status: "Pending",
          createdAt: serverTimestamp(),
          authorId: currentUserId,
        });
        logSolutionForm.reset();
        showNotification("Solution for log added!", "success");
      });

      locationFilter.addEventListener("change", () => {
        selectedCaseId ? renderCaseSolutionsTable() : renderStudentLogTable();
      });
      caseSortFilter.addEventListener("change", populateViewAllModal);
      caseGroupFilter.addEventListener("change", populateViewAllModal);
      clearSelectionBtn.addEventListener("click", handleClearSelection);

      // --- Event Delegation for Dynamic Content ---
      document.addEventListener("click", async (e) => {
        const caseCard = e.target.closest(".case-card");
        if (caseCard) {
          const caseId = caseCard.dataset.id;
          const caseData = allCases.find((c) => c.id === caseId);
          if (e.target.closest(".case-content-wrapper")) {
            handleCaseClick(caseId, caseData.title);
            if (viewAllCasesModal.contains(caseCard))
              viewAllCasesModal.classList.add("hidden");
          } else if (e.target.closest(".agree-btn")) {
            await updateDoc(doc(db, "studyCases", caseId), {
              agreements: increment(1),
            });
          } else if (e.target.closest(".delete-case-btn")) {
            itemToDelete = { id: caseId, type: "case" };
            deleteModalTitle.textContent = "Delete Study Case";
            deleteModalText.textContent =
              "Are you sure? Deleting a case will also delete all of its entries. This action cannot be undone.";
            deleteModal.classList.remove("hidden");
          } else if (e.target.closest(".view-details-btn")) {
            showCaseDetailsModal(caseId);
          }
        }

        const tableRow = e.target.closest("tr");
        if (tableRow) {
          const itemId = tableRow.dataset.id;
          if (e.target.closest(".view-log-details-btn")) {
            showLogDetailsModal(itemId);
          } else if (e.target.closest(".delete-log-btn")) {
            itemToDelete = { id: itemId, type: "log" };
            deleteModalTitle.textContent = "Delete Log Entry";
            deleteModalText.textContent =
              "Are you sure? This will also delete all solutions for this log.";
            deleteModal.classList.remove("hidden");
          } else if (e.target.closest(".delete-solution-btn")) {
            itemToDelete = { id: itemId, type: "solution" };
            deleteModalTitle.textContent = "Delete Solution";
            deleteModalText.textContent =
              "Are you sure you want to delete this solution?";
            deleteModal.classList.remove("hidden");
          }
        }

        const solutionAgreeBtn = e.target.closest(".solution-agree-btn");
        if (solutionAgreeBtn) {
          const solutionId = solutionAgreeBtn.dataset.solutionId;
          if (solutionId) {
            await updateDoc(doc(db, "caseSolutions", solutionId), {
              agreements: increment(1),
            });
          }
        }

        const logSolutionStatusSelect = e.target.closest(
          ".log-solution-status-select"
        );
        if (logSolutionStatusSelect) {
          const solutionId = logSolutionStatusSelect.dataset.solutionId;
          const newStatus = logSolutionStatusSelect.value;
          if (solutionId) {
            await updateDoc(doc(db, "logSolutions", solutionId), {
              status: newStatus,
            });
          }
        }
      });

      // --- Modal Listeners ---
      addCaseBtn.addEventListener("click", () =>
        addCaseModal.classList.remove("hidden")
      );
      modalCaseCancel.addEventListener("click", () =>
        addCaseModal.classList.add("hidden")
      );
      addCaseForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        await addDoc(studyCasesCollectionRef, {
          title: document.getElementById("case-title").value,
          group: document.getElementById("case-group").value,
          description: document.getElementById("case-description").value,
          agreements: 0,
          createdAt: serverTimestamp(),
          authorId: currentUserId,
        });
        addCaseForm.reset();
        addCaseModal.classList.add("hidden");
        showNotification("Study case created!", "success");
      });

      viewAllCasesBtn.addEventListener("click", () => {
        populateViewAllModal();
        viewAllCasesModal.classList.remove("hidden");
      });
      modalViewAllClose.addEventListener("click", () =>
        viewAllCasesModal.classList.add("hidden")
      );
      modalDetailsClose.addEventListener("click", () =>
        viewDetailsModal.classList.add("hidden")
      );
      modalLogDetailsClose.addEventListener("click", () => {
        logDetailsModal.classList.add("hidden");
        selectedLogId = null; // Clear selected log when closing
      });

      modalDeleteCancel.addEventListener("click", () =>
        deleteModal.classList.add("hidden")
      );
      modalDeleteConfirm.addEventListener("click", async () => {
        if (!itemToDelete.id) return;
        try {
          if (itemToDelete.type === "case") {
            await deleteCaseAndSolutions(itemToDelete.id);
            showNotification("Case and its solutions deleted!", "success");
          } else if (itemToDelete.type === "log") {
            await deleteLogAndSolutions(itemToDelete.id);
            showNotification("Log entry and its solutions deleted!", "success");
          } else if (itemToDelete.type === "solution") {
            await deleteDoc(doc(db, "caseSolutions", itemToDelete.id));
            showNotification("Solution deleted!", "success");
          }
        } catch (err) {
          showNotification("Error deleting item.", "error");
          console.error(err);
        } finally {
          deleteModal.classList.add("hidden");
          itemToDelete = { id: null, type: null };
        }
      });

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        const themeToggle = document.getElementById("theme-toggle");

        const savedTheme = localStorage.getItem("theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme) {
          applyTheme(savedTheme);
        } else if (systemPrefersDark) {
          applyTheme("dark");
        } else {
          applyTheme("light");
        }

        themeToggle.addEventListener("click", () => {
          const isDarkMode =
            document.documentElement.classList.contains("dark");
          const newTheme = isDarkMode ? "light" : "dark";
          localStorage.setItem("theme", newTheme);
          applyTheme(newTheme);
        });
      });
    </script>
  </body>
</html>
